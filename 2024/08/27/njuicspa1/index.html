<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>njuicspa1 | Yaan</title><meta name="keywords" content="计算机系统基础,ics,pa"><meta name="author" content="Yaan"><meta name="copyright" content="Yaan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="njuicspa1"><meta name="application-name" content="njuicspa1"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="njuicspa1"><meta property="og:url" content="https://yaanlaan.github.io/2024/08/27/njuicspa1/index.html"><meta property="og:site_name" content="Yaan"><meta property="og:description" content="南京大学ics2023版pa，pa1实现nemu的monitor功能"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://yaanlaan.github.io/img/postimage/%E8%80%81%E5%85%AB2.jpg"><meta property="article:author" content="Yaan"><meta property="article:tag" content="摆烂"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://yaanlaan.github.io/img/postimage/%E8%80%81%E5%85%AB2.jpg"><meta name="description" content="南京大学ics2023版pa，pa1实现nemu的monitor功能"><link rel="shortcut icon" href="/mysitesource/256.png"><link rel="canonical" href="https://yaanlaan.github.io/2024/08/27/njuicspa1/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="manifest" href="/manifest.json"/><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"/><link rel="mask-icon" href="/img/mysitesource/256.png" color="#5bbad5"/><link rel="apple-touch-icon" sizes="180x180" href="/img/mysitesource/256.png"/><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/mysitesource/256.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/mysitesource/256.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/mysitesource/256.png"/><link rel="bookmark" href="/img/mysitesource/256.png"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: undefined,
  diytitle: {"enable":true,"leaveTitle":"(- - )","backTitle":"♪(^∇^*)"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🫡 大白白兰兰专业户","😶‍🌫️ 大专天才少年沉淀"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Yaan","link":"链接: ","source":"来源: Yaan","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Yaan',
  title: 'njuicspa1',
  postAI: '',
  pageFillDescription: 'NJU ICS PA1, 愉快的PA之前, 开天辟地的篇章, RTFSC, 第一个小实验, 课后小练习：优雅的退出, 基础设施, 解析命令, 单步执行, 打印寄存器, 扫描内存, 表达式求值, 监视点, 添加监视点信息, 监视点的分配和释放, 完善命令, 结果展示本记录主要为操作向因为是基础课所以笔记写得可能很琐碎且烂我的环境是的环境配置就不重复了因为以前折腾过环境现在环境是直接用的不过也许会补上但是大概率是写一些心得愉快的之前按照指引操作即可展示一下运行的游戏吧在的里下载压缩包在中可以使用进行解压缩这时候得到的其实是个压缩包再次解压就得到的文件夹里面有许多文件就是小游戏了按照指引放到下然后运行即可例如这个好玩捏然后会发现编译的时间有点慢可以开启多线程只要在后面添加参数即可为具体数字所谓多线程就是把计算任务分到几个不同的线程上计算这些任务通常是并行的比如你要计算四个假设有个一共就是次加法这个时间很长单线程必须等前面算完才可以算但是多线程可以把他放到四个线程上计算不记分配时间而且假设同时运行只需要次计算时间或者配置字面意思是的高速缓存查看的手册可以发现手册中写道所以只要在环境中添加路径即可终端输入并在末尾添加即可然后输入生效再然后执行可以发现输出变成了顺便提一下关于的环境变量针对当前用户就是当前用户的文件夹下的那个对应用户名的文件夹可以查看是每一个用户都使用这时候第一次编译会变得很慢不过你正好可以试试参数但是后面的编译就会很快啦完成捏开天辟地的篇章本节介绍一个重要的概念程序是个状态机还介绍了一些存储器的知识状态机的概念没有严格学习过只要知道是从状态接收输入会发生转移的机器就行啦这会在调试的过程中逐步加深理解的类似的缩写还有很多比如摘录一下老师所用的课程教材里面的一句话中的只是为这个短语增加了一些色彩可以用打印一下目录结构记录一下层数目录这块除了的基础框架主要介绍了配置文件编译项目然后就是加强程序的概念计算机是如何启动的可以打印日志康康为什么都是函数代码复用结构化程序宏是如何运作的在预处理的时候进行替代把宏替换成对应的字母如何使用解析参数第一个小实验然后发布了的第一个小实验运行客户程序当然你首先需要先试试原来的程序看看在哪里输入程序之后编译可以成功在目录下有运行即可会有断言给出了在哪儿找到按照要求注释掉这两行即可再次编译可以成功运行输入提示为退出为继续运行输入发现执行了几条指令输出了一些日志这些指令是汇编指令这时候你会发现已经完成了第一个小小问题了笑课后小练习优雅的退出现在的程序运行后直接输入呢会报错但是先后却不会修正这个错误注意如果是在终端中直接运行可执行文件不会输出报错内容哦但是前面的点变红了就说明报错了可以正常报错告诉我们报错文件在没什么头绪显然得使用调试来解决了使用调试记得要打开里面的运行勾选上即可打开然后输入文件或者直接打开文件首先是可以正常输出的所以可以在前打断点然后使用进入函数里探究一下调试的时候最好对照完整的代码分析可以另开一个窗口课程里当然是推荐啦不过我是用偷个懒只有一个函数继续进入内部这个函数主要是用来解析命令行的所以问题大概率在这里发生可以粗暴的一直用结果发现会出现一个解析的循环每次会跳出一行来读取字符而且未知字符的解析可以正常现在我们在那一行输入然后继续使用果然出现了错误刚一返回上一层就报错我们先分析一下这一层的返回值是否正确三种命令命令描述调用函数批处理模式获取命令行输入尾指针获取第一个空格前的字符串首个字符串暂时不管和几个命令比较处理对应函数三个都不是那就是非法输入可以再次调试打印和之类的解析结果发现命令的解析没有问题所以问题还可能处在对应的了而为然后我们发现返回值也正常返回会跳过继续解析而会似乎没什么问题那问题就在上一层了而上一层一直返回到然后运行这时候我们看看这个函数根据来判断程序退出状态这个宏的意思不太明白我们继续转跳根据字面意思枚举表示正在运行表示暂停运行表示正常结束表示异常结束表示退出结构体表示的状态取值范围为上述枚举类型中的值表示暂停运行时的程序计数器值表示暂停运行时的返回值我们再次调试查看结构体的值也就相当于也就是这点使得所以返回为出现了报错我们返回找这条支线上不存在修改状态的语句所以我们可以试着在这条支线上寻找正确的实现进入可以发现这里实现了状态的修改所以我们只要在里面也添加上状态的修改就好啦正确的状态是至于暂时没什么问题即使是中也没有修改我们暂且就不强行修改了添加状态的修改最后重新编译优雅地退出基础设施所谓基础设施大概就是指现代工具链吧结合小故事也许还包含硬件设备总之大概就是提升开发效率一类的东西我们要做的就是就是补全的功能让它真正称为的基础设施下面有张功能表命令格式使用举例说明帮助打印命令的帮助信息继续运行继续运行被暂停的程序退出退出单步执行让程序单步执行条指令后暂停执行当没有给出时缺省为打印程序状态打印寄存器状态打印监视点信息扫描内存求出表达式的值将结果作为起始内存地址以十六进制形式输出连续的个字节表达式求值求出表达式的值支持的运算请见调试中的表达式求值小节设置监视点当表达式的值发生变化时暂停程序执行删除监视点删除序号为的监视点其实整个就是实现和完善这张表的功能下面我们一个个来解析命令我们一步步完成首先实现命令解析但是不实现完整的功能测试函数和命令的读入编译后输入和一些测试命令可以得到接下来就逐个实现功能就可以了每个函数里对再处理然后执行相应的功能单步执行仿照的实现解析命令然后判断是否为合法输入执行即可默认为打印寄存器解析命令然后打印寄存器需要修改需要包含扫描内存记得要包含也是解析一下命令行就可以得到的是地址所以需要设置为模拟一个地址暂时不需要实现表达式的解析直接接受数字即可用了两个转换函数和是将字符串转换为整数是将字符串转换为第三个参数是进制表示自动识别第一个参数第二个参数命令解析表达式解析暂时不解析只是数字检查地址是否在内存范围内输出结果格式化输出个字节地址加尝试运行一下得到如下结果写到这里第一部分就结束了不得不说确实有些难度表达式求值这一块涉及到一些编译原理也涉及一些数据结构的知识一个是词法分析一个是如何计算表达式顺带推荐一下的编译原理甚至还提供校外账号课程还是太优质了修改文件看一节编译原理的就差不多明白了可以按照那一节的内容指定规则首先制定规则为了后面调试方便指定一张表输出对应字符要先于数字匹配后面要处理运算优先级所以再给个获取运算优先级的函数首先呢是分割代码已经给好了框架遍历规则识别这里和前面的顺序是对应上的正是因为遍历所以需要在最前面识别遍历规则直接跳过解引用和符号判断一样减法或者乘法都是一串字符统一处理没有特殊处理然后是求值课程也给了框架明显需要递归解决递归的依据是有几个一个需要处理这三种两个需要处理负数和解引用多个需要判断括号然后是计算优先级最后递归得到左右值计算空串错误单处理地址两为负数和解引用是否是括号优先级处理越多说明越里层求最高级没有运算符然后然后就终于结束了调试了很久而且许多函数也不会用编译原理也不太会还是太困难了展示一下结果吧休息休息一下监视点添加监视点信息首先呢我们需要试试的功能看看监视点都有什么功能并且在结构体里添加合适的成员监视点链表监视点信息目标信息存放表达式结果即内存地址执行指令之前的值监视点的分配和释放首先不考虑如何输入监视的内容只考虑监视池的分配这里修改了的返回类型为新建节点插入链表的前端初始化监视点默认启用监视点编号释放节点判断当前节点从占用链表删除如果是头节点从占有链表删除查找节点从占有链表删除加入空闲链表空闲链表非空加入空闲然后给出打印监视点和监视池的信息打印某个监视点打印所有监视点完善命令然后去完善命令一共有三个命令分别是比较简单再写一个函数调用即可我们的是按照地址分配的所以不需要遍历查找因为名称我们用了所以一定要记得其他命令在对应的中完善命令第一个参数命令解析检查地址是否在内存范围内监控点信息命令第一个参数删除监视点结果展示至此打工告成代码中许多功能其实并不是很完善不过已经花了很多时间有空再修正吧后面的章节随缘更新吧没想的的代码量这么大',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-27 19:36:54',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="Yaan" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/mysitesource/yaanblog.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">Yaan</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><span> 文章</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><span> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:toRandomPost()"><span> 随便逛逛</span></a></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 1.05rem;">C++<sup>9</sup></a><a href="/tags/LINGO/" style="font-size: 1.05rem;">LINGO<sup>2</sup></a><a href="/tags/MATLAB/" style="font-size: 1.05rem;">MATLAB<sup>11</sup></a><a href="/tags/Mind-Walk/" style="font-size: 1.05rem;">Mind Walk<sup>1</sup></a><a href="/tags/c/" style="font-size: 1.05rem;">c++<sup>2</sup></a><a href="/tags/cmake/" style="font-size: 1.05rem;">cmake<sup>2</sup></a><a href="/tags/cs144/" style="font-size: 1.05rem;">cs144<sup>2</sup></a><a href="/tags/ics/" style="font-size: 1.05rem;">ics<sup>1</sup></a><a href="/tags/opencv/" style="font-size: 1.05rem;">opencv<sup>1</sup></a><a href="/tags/pa/" style="font-size: 1.05rem;">pa<sup>1</sup></a><a href="/tags/stl/" style="font-size: 1.05rem;">stl<sup>1</sup></a><a href="/tags/tools/" style="font-size: 1.05rem;">tools<sup>2</sup></a><a href="/tags/%E4%BF%A1%E6%81%AF%E8%AE%BA/" style="font-size: 1.05rem;">信息论<sup>1</sup></a><a href="/tags/%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B/" style="font-size: 1.05rem;">微分方程<sup>2</sup></a><a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 1.05rem;">排序<sup>1</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 1.05rem;">数字图像处理<sup>1</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6%E5%BB%BA%E6%A8%A1/" style="font-size: 1.05rem;">数学建模<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 1.05rem;">数据结构<sup>1</sup></a><a href="/tags/%E6%95%B0%E8%AE%BA/" style="font-size: 1.05rem;">数论<sup>1</sup></a><a href="/tags/%E6%9C%AC%E7%A7%91%E7%AC%94%E8%AE%B0/" style="font-size: 1.05rem;">本科笔记<sup>13</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 1.05rem;">模板<sup>1</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 1.05rem;">测试<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">算法<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95%E6%9D%82%E8%B0%88/" style="font-size: 1.05rem;">算法杂谈<sup>2</sup></a><a href="/tags/%E7%BA%BF%E6%80%A7%E8%A7%84%E5%88%92/" style="font-size: 1.05rem;">线性规划<sup>2</sup></a><a href="/tags/%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98/" style="font-size: 1.05rem;">背包问题<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/" style="font-size: 1.05rem;">计算机图形学<sup>9</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">计算机系统基础<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">计算机网络<sup>2</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">17</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/nju-ics-2023/" itemprop="url">nju-ics-2023</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>计算机系统基础</span></a><a class="article-meta__tags" href="/tags/ics/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>ics</span></a><a class="article-meta__tags" href="/tags/pa/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>pa</span></a></span></div></div><h1 class="post-title" itemprop="name headline">njuicspa1</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-08-27T11:24:09.000Z" title="发表于 2024-08-27 19:24:09">2024-08-27</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-08-27T11:36:54.071Z" title="更新于 2024-08-27 19:36:54">2024-08-27</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">109k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>6:35分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为安徽"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>安徽</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/img/postimage/%E8%80%81%E5%85%AB2.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://yaanlaan.github.io/2024/08/27/njuicspa1/"><header><a class="post-meta-categories" href="/categories/nju-ics-2023/" itemprop="url">nju-ics-2023</a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/" tabindex="-1" itemprop="url">计算机系统基础</a><a href="/tags/ics/" tabindex="-1" itemprop="url">ics</a><a href="/tags/pa/" tabindex="-1" itemprop="url">pa</a><h1 id="CrawlerTitle" itemprop="name headline">njuicspa1</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Yaan</span><time itemprop="dateCreated datePublished" datetime="2024-08-27T11:24:09.000Z" title="发表于 2024-08-27 19:24:09">2024-08-27</time><time itemprop="dateCreated datePublished" datetime="2024-08-27T11:36:54.071Z" title="更新于 2024-08-27 19:36:54">2024-08-27</time></header><h1 id="nju-ics-pa1">NJU ICS PA1</h1>
<blockquote>
<p>本记录主要为操作向，因为ICS是基础课，所以笔记写得可能很琐碎（且烂）
我的环境是wsl2 ubuntu2204
，PA0的环境配置就不重复了，因为以前折腾过环境，现在环境是直接用的，不过也许会补上PA0，但是大概率是写一些心得QAQ</p>
</blockquote>
<h2 id="愉快的pa之前">愉快的PA之前</h2>
<p>按照指引操作即可，展示一下运行的游戏吧（在jyy的wiki里下载压缩包<a target="_blank" rel="noopener" href="https://jyywiki.cn/ICS/2021/labs/PA1.html">jyywiki.cn/ICS/2021/labs/PA1.html</a>)</p>
<p>在linux中可以使用bzpi2进行解压缩</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bzip2 -d rom.tar.bz2</span><br></pre></td></tr></table></figure>
<p>这时候得到的其实是个.tar压缩包，再次解压就得到rom的文件夹，里面有许多.nes文件，就是小游戏了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf rom.tar</span><br></pre></td></tr></table></figure>
<p>按照指引放到rom下然后运行即可</p>
<p>例如这个mario3</p>
<figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/08/27/njuicspa1/mario3.png" alt="mario3">
<figcaption aria-hidden="true">mario3</figcaption>
</figure>
<blockquote>
<p>好玩捏QAQ</p>
</blockquote>
<p>然后会发现编译的时间有点慢，可以开启多线程，只要在make后面添加-j?参数即可(j为具体数字)。</p>
<blockquote>
<p>（所谓多线程就是把计算任务分到几个不同的线程上计算，这些任务通常是并行的，比如你要计算四个1+1+1+...+1，假设有n个1，一共就是4*（n-1）次加法,这个时间很长，单线程必须等前面算完才可以算，但是多线程可以把他放到四个线程上计算，不记分配时间而且假设同时运行，只需要n-1次计算时间</p>
</blockquote>
<p>或者配置ccache（字面意思是c的cache[高速缓存]），查看ccache的手册，可以发现手册中写道：</p>
<blockquote>
<p>There are two ways to use ccache. You can either prefix your
compilation commands with ccache or you can let ccache masquerade as the
compiler by creating a symbolic link (named as the compiler) to ccache.
The first method is most convenient if you just want to try out ccache
or wish to use it for some specific projects. The second method is most
useful for when you wish to use ccache for all your compilations.</p>
</blockquote>
<p>所以只要在环境中添加ccache路径即可，终端输入
<code>vim  ~/.bashrc</code>，并在末尾添加
<code>export CCACHE_DIR=/path/to/your/cache</code>即可。 然后输入
<code>source ~/.bashrc</code>生效。 再然后执行
<code>which gcc</code>，可以发现输出变成了</p>
<blockquote>
<p>顺便提一下关于linux的环境变量，<sub>/.bashrc针对当前用户(</sub>就是当前用户的文件夹home下的那个对应用户名的文件夹，可以ls
-a查看)，/ect/bash.bashrc是每一个用户都使用（ubuntu）</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/ccache/gcc</span><br></pre></td></tr></table></figure>
<p>这时候第一次编译会变得很慢，不过你正好可以试试-j?参数，但是后面的编译就会很快啦。</p>
<p>完成捏&gt;_&lt;</p>
<h2 id="开天辟地的篇章">开天辟地的篇章</h2>
<p>本节介绍一个重要的概念，<code>程序是个状态机</code>还介绍了一些存储器，cpu的知识。（状态机的概念没有严格学习过，只要知道是从状态接收输入会发生转移的机器就行啦）</p>
<p>这会在调试的过程中逐步加深理解的。</p>
<h2 id="rtfsc">RTFSC</h2>
<blockquote>
<p>Read the Fucking Souruce
Code.类似的缩写还有很多比如RTFM，摘录一下jyy老师os所用的课程教材里面的一句话：RTFM中的F只是为这个短语增加了一些色彩......</p>
</blockquote>
<p>可以用tree打印一下目录结构记录一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree -L 3(层数) .(目录)</span><br></pre></td></tr></table></figure>
<p>这块除了nemu的基础框架，主要介绍了</p>
<ul>
<li>配置文件</li>
<li>编译项目</li>
</ul>
<p>然后就是加强程序的概念：</p>
<ul>
<li>计算机是如何启动的？可以打印日志康康</li>
<li>为什么都是函数？代码复用、结构化程序</li>
<li>宏是如何运作的？在预处理的时候进行替代，把宏替换成对应的"字母"</li>
<li>如何使用getopt_long()解析参数</li>
</ul>
<h3 id="第一个小实验">第一个小实验</h3>
<p>然后发布了PA1的第一个小实验</p>
<blockquote>
<p>运行客户程序</p>
</blockquote>
<p>当然你首先需要先试试原来make的程序，看看在哪里输入程序。make之后编译可以成功，在build目录下有.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── obj-riscv32-nemu-interpreter</span><br><span class="line">└── riscv32-nemu-interpreter</span><br></pre></td></tr></table></figure>
<p>运行 <code>riscv32-nemu-interpreter</code>即可，会有断言</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[src/<span class="literal">monitor</span>/<span class="literal">monitor</span>.c:<span class="number">35</span> welcome] Exercise: Please remove me <span class="keyword">in</span> the source code <span class="keyword">and</span> compile NEMU again.</span><br><span class="line">riscv32-nemu-interpreter: src/<span class="literal">monitor</span>/<span class="literal">monitor</span>.c:<span class="number">36</span>: welcome: Assertion `<span class="number">0</span>' failed.</span><br><span class="line">Aborted</span><br></pre></td></tr></table></figure>
<p>给出了在哪儿，找到monitor，按照要求注释掉这两行即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Log(<span class="string">"Exercise: Please remove me in the source code and compile NEMU again."</span>);</span><br><span class="line">assert(0);</span><br></pre></td></tr></table></figure>
<p>再次编译，可以成功运行，输入help提示q为退出c为继续运行，输入c发现执行了几条指令输出了一些日志（这些指令是汇编指令）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Welcome to riscv32-NEMU!</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span></span><br><span class="line">(nemu) <span class="built_in">help</span></span><br><span class="line"><span class="built_in">help</span> - Display information about all supported commands</span><br><span class="line">c - Continue the execution of the program</span><br><span class="line">q - Exit NEMU</span><br><span class="line">(nemu) c</span><br><span class="line">0x80000000: 00 00 02 97 auipc   t0, 0</span><br><span class="line">0x80000004: 00 02 88 23 sb      zero, 16(t0)</span><br><span class="line">0x80000008: 01 02 c5 03 lbu     a0, 16(t0)</span><br><span class="line">0x8000000c: 00 10 00 73 ebreak</span><br><span class="line">[src/cpu/cpu-exec.c:120 cpu_exec] nemu: HIT GOOD TRAP at pc = 0x8000000c</span><br><span class="line">[src/cpu/cpu-exec.c:120 cpu_exec] nemu: HIT GOOD TRAP at pc = 0x8000000c</span><br><span class="line">[src/cpu/cpu-exec.c:88 statistic] host time spent = 1256 us</span><br><span class="line">[src/cpu/cpu-exec.c:88 statistic] host time spent = 1256 us</span><br><span class="line">[src/cpu/cpu-exec.c:89 statistic] total guest instructions = 4</span><br><span class="line">[src/cpu/cpu-exec.c:89 statistic] total guest instructions = 4</span><br><span class="line">[src/cpu/cpu-exec.c:90 statistic] simulation frequency = 3184 inst/s</span><br><span class="line">[src/cpu/cpu-exec.c:90 statistic] simulation frequency = 3184 inst/s</span><br></pre></td></tr></table></figure>
<p>这时候你会发现已经完成了第一个小小问题了（笑）</p>
<h3 id="课后小练习优雅的退出">课后小练习：优雅的退出</h3>
<p>现在的程序运行后直接输入q呢，会报错，但是先
c后q却不会，修正这个错误。(注意如果是在vscode终端中直接运行可执行文件不会输出报错内容哦，但是前面的点变红了就说明报错了，make
run可以正常报错)，告诉我们报错文件在native.mk，没什么头绪，显然得使用调试来解决了</p>
<p>使用gdb调试（记得要打开config里面的<strong>Enable debug
information</strong>，运行make menuconfig勾选上即可）</p>
<p>打开gdb然后输入文件（或者直接打开文件
<code>gdb rscv32-nemu-interpreter</code>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file riscv32-nemu-interpreter</span><br></pre></td></tr></table></figure>
<p>首先，welcome是可以正常输出的，所以可以在
<code>engine_start</code>前打断点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b engine_start</span><br><span class="line"></span><br><span class="line">r</span><br></pre></td></tr></table></figure>
<p>然后使用s进入函数里探究一下</p>
<blockquote>
<p>调试的时候最好对照完整的代码分析，可以另开一个窗口，课程里当然是推荐tmux啦，不过我是用vscode，偷个懒</p>
</blockquote>
<p><code>engine_start</code>只有一个函数
<code>sdb_mainloop</code>，继续s进入
<code>sdb_mainloop</code>内部，这个函数主要是用来解析命令行的，所以问题大概率在这里发生。</p>
<p>可以粗暴的一直用n，结果发现会出现一个解析的循环，每次会跳出一行（nemu）来读取字符，而且未知字符n的解析可以正常。</p>
<p>现在我们在那一行输入q，然后继续使用n，果然出现了错误，刚一返回上一层就报错，我们先分析一下这一层的返回值是否正确。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> {</span><span class="comment">// 三种命令，命令：描述：调用函数</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *description;</span><br><span class="line">  <span class="type">int</span> (*handler) (<span class="type">char</span> *);</span><br><span class="line">} cmd_table [] = {</span><br><span class="line">  { <span class="string">"help"</span>, <span class="string">"Display information about all supported commands"</span>, cmd_help },</span><br><span class="line">  { <span class="string">"c"</span>, <span class="string">"Continue the execution of the program"</span>, cmd_c },</span><br><span class="line">  { <span class="string">"q"</span>, <span class="string">"Exit NEMU"</span>, cmd_q },</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">};</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sdb_mainloop</span><span class="params">()</span> {</span><br><span class="line">  <span class="keyword">if</span> (is_batch_mode) {<span class="comment">// 批处理模式</span></span><br><span class="line">    cmd_c(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">char</span> *str; (str = rl_gets()) != <span class="literal">NULL</span>; ) {<span class="comment">//获取命令行输入</span></span><br><span class="line">    <span class="type">char</span> *str_end = str + <span class="built_in">strlen</span>(str);<span class="comment">//尾指针</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* extract the first token as the command */</span></span><br><span class="line">    <span class="type">char</span> *cmd = strtok(str, <span class="string">" "</span>);<span class="comment">// 获取第一个空格前的字符串(首个字符串)</span></span><br><span class="line">    <span class="keyword">if</span> (cmd == <span class="literal">NULL</span>) { <span class="keyword">continue</span>; }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* treat the remaining string as the arguments,</span></span><br><span class="line"><span class="comment">     * which may need further parsing</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">char</span> *args = cmd + <span class="built_in">strlen</span>(cmd) + <span class="number">1</span>;<span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (args &gt;= str_end) {</span><br><span class="line">      args = <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEVICE<span class="comment">// 暂时不管</span></span></span><br><span class="line">    <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">sdl_clear_event_queue</span><span class="params">()</span>;</span><br><span class="line">    sdl_clear_event_queue();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NR_CMD; i ++) {<span class="comment">// 和几个命令比较，处理对应函数</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cmd, cmd_table[i].name) == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">if</span> (cmd_table[i].handler(args) &lt; <span class="number">0</span>) { <span class="keyword">return</span>; }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i == NR_CMD) { <span class="built_in">printf</span>(<span class="string">"Unknown command '%s'\n"</span>, cmd); }<span class="comment">//三个都不是那就是非法输入</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>可以再次调试，打印str和cmd之类的解析结果，发现命令的解析没有问题，所以问题还可能处在q对应的cmd_q()了</p>
<p>而cmd_q,cmd_c为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_c</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  cpu_exec(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_q</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>然后我们发现返回值也正常，返回0会跳过继续解析，而-1会return。似乎没什么问题，那问题就在上一层了。</p>
<p>而上一层一直返回到main，然后运行
<code>is_exit_status_bad()</code>。</p>
<p>这时候我们看看这个函数</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NEMUState nemu_state = { .<span class="keyword">state</span> = NEMU_STOP };</span><br><span class="line"></span><br><span class="line">int is_exit_status_bad() {</span><br><span class="line">  int good = (nemu_state.<span class="keyword">state</span> == NEMU_END &amp;&amp; nemu_state.halt_ret == <span class="number">0</span>) ||</span><br><span class="line">    (nemu_state.<span class="keyword">state</span> == NEMU_QUIT);</span><br><span class="line">  return !good;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>根据nemu_state来判断程序退出状态，这个宏的意思不太明白，我们继续转跳</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> { NEMU_RUNNING, NEMU_STOP, NEMU_END, NEMU_ABORT, NEMU_QUIT };</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> {</span><br><span class="line">  <span class="type">int</span> state;</span><br><span class="line">  <span class="type">vaddr_t</span> halt_pc;</span><br><span class="line">  <span class="type">uint32_t</span> halt_ret;</span><br><span class="line">} NEMUState;</span><br></pre></td></tr></table></figure>
<p>根据字面意思</p>
<p>枚举</p>
<ul>
<li><code>NEMU_RUNNING</code>：表示 NEMU 正在运行。</li>
<li><code>NEMU_STOP</code>：表示 NEMU 暂停运行。</li>
<li><code>NEMU_END</code>：表示 NEMU 正常结束。</li>
<li><code>NEMU_ABORT</code>：表示 NEMU 异常结束。</li>
<li><code>NEMU_QUIT</code>：表示 NEMU 退出。</li>
</ul>
<p>结构体</p>
<ul>
<li><code>state</code>：表示 NEMU
的状态，取值范围为上述枚举类型中的值。</li>
<li><code>halt_pc</code>：表示暂停运行时的程序计数器值。</li>
<li><code>halt_ret</code>：表示暂停运行时的返回值。</li>
</ul>
<p>我们再次调试，查看结构体的值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">print</span> nemu_state.state</span><br><span class="line"><span class="variable">$1</span> = 1</span><br><span class="line">(gdb) <span class="built_in">print</span> nemu_state.halt_ret</span><br><span class="line"><span class="variable">$2</span> = 0</span><br></pre></td></tr></table></figure>
<p>也就相当于nemu_state.state=NEMU_STOP，也就是这点使得good=0，所以返回为1，出现了报错。我们返回找cmd_q这条支线上不存在修改状态的语句。所以我们可以试着在c这条支线上寻找正确的实现，进入cpu_exec可以发现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Simulate how the CPU works. */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cpu_exec</span><span class="params">(<span class="type">uint64_t</span> n)</span> {</span><br><span class="line">  g_print_step = (n &lt; MAX_INST_TO_PRINT);</span><br><span class="line">  <span class="keyword">switch</span> (nemu_state.state) {</span><br><span class="line">    <span class="keyword">case</span> NEMU_END: <span class="keyword">case</span> NEMU_ABORT:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Program execution has ended. To restart the program, exit NEMU and run again.\n"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">default</span>: nemu_state.state = NEMU_RUNNING;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> timer_start = get_time();</span><br><span class="line"></span><br><span class="line">  execute(n);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> timer_end = get_time();</span><br><span class="line">  g_timer += timer_end - timer_start;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (nemu_state.state) {<span class="comment">//这里实现了状态的修改</span></span><br><span class="line">    <span class="keyword">case</span> NEMU_RUNNING: nemu_state.state = NEMU_STOP; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NEMU_END: <span class="keyword">case</span> NEMU_ABORT:</span><br><span class="line">      Log(<span class="string">"nemu: %s at pc = "</span> FMT_WORD,</span><br><span class="line">          (nemu_state.state == NEMU_ABORT ? ANSI_FMT(<span class="string">"ABORT"</span>, ANSI_FG_RED) :</span><br><span class="line">           (nemu_state.halt_ret == <span class="number">0</span> ? ANSI_FMT(<span class="string">"HIT GOOD TRAP"</span>, ANSI_FG_GREEN) :</span><br><span class="line">            ANSI_FMT(<span class="string">"HIT BAD TRAP"</span>, ANSI_FG_RED))),</span><br><span class="line">          nemu_state.halt_pc);</span><br><span class="line">      <span class="comment">// fall through</span></span><br><span class="line">    <span class="keyword">case</span> NEMU_QUIT: statistic();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>所以我们只要在cpu_p里面也添加上状态的修改就好啦，正确的状态是NEMU_END</p>
<blockquote>
<p>至于nemu_state.halt_ret暂时没什么问题，即使是cmd_c中也没有修改，我们暂且就不强行修改了。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_q</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  nemu_state.state = NEMU_END;<span class="comment">//添加状态的修改</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>最后重新编译，优雅地退出！</p>
<h2 id="基础设施">基础设施</h2>
<p>所谓基础设施，大概就是指现代工具链吧（结合小故事，也许还包含硬件设备，总之大概就是提升开发效率一类的东西）
我们要做的就是就是补全monitor的功能，让它真正称为nemu的基础设施，下面有张功能表</p>
<table>
<colgroup>
<col style="width: 10%">
<col style="width: 9%">
<col style="width: 11%">
<col style="width: 67%">
</colgroup>
<thead>
<tr class="header">
<th>命令</th>
<th>格式</th>
<th>使用举例</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>帮助(1)</td>
<td>help</td>
<td>help</td>
<td>打印命令的帮助信息</td>
</tr>
<tr class="even">
<td>继续运行(1)</td>
<td>c</td>
<td>c</td>
<td>继续运行被暂停的程序</td>
</tr>
<tr class="odd">
<td>退出(1)</td>
<td>q</td>
<td>q</td>
<td>退出NEMU</td>
</tr>
<tr class="even">
<td>单步执行</td>
<td>si [N]</td>
<td>si 10</td>
<td>让程序单步执行N条指令后暂停执行, 当N没有给出时, 缺省为1</td>
</tr>
<tr class="odd">
<td>打印程序状态</td>
<td>info SUBCMD</td>
<td>info r/info w</td>
<td>打印寄存器状态/打印监视点信息</td>
</tr>
<tr class="even">
<td>扫描内存(2)</td>
<td>x N EXPR</td>
<td>x 10 $esp</td>
<td>求出表达式EXPR的值, 将结果作为起始内存地址,
以十六进制形式输出连续的N个4字节</td>
</tr>
<tr class="odd">
<td>表达式求值</td>
<td>p EXPR</td>
<td>p $eax + 1</td>
<td>求出表达式EXPR的值, EXPR支持的运算请见调试中的表达式求值小节</td>
</tr>
<tr class="even">
<td>设置监视点</td>
<td>w EXPR</td>
<td>w *0x2000</td>
<td>当表达式EXPR的值发生变化时, 暂停程序执行</td>
</tr>
<tr class="odd">
<td>删除监视点</td>
<td>d N</td>
<td>d 2</td>
<td>删除序号为N的监视点</td>
</tr>
</tbody>
</table>
<p>其实整个PA1就是实现和完善这张表的功能。下面我们一个个来</p>
<h3 id="解析命令">解析命令</h3>
<p>我们一步步完成，首先实现命令解析，但是不实现完整的功能，测试help函数和命令的读入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_si</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"cmd_si%s\n"</span>,args);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_info</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"cmd_info%s\n"</span>,args);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_x</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"cmd_x%s\n"</span>,args);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_p</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"cmd_p%s\n"</span>,args);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_w</span><span class="params">(<span class="type">char</span>* args)</span> {</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"cmd_w%s\n"</span>,args);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_d</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"cmd_d%s\n"</span>,args);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_help</span><span class="params">(<span class="type">char</span> *args)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_c</span><span class="params">(<span class="type">char</span> *args)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_q</span><span class="params">(<span class="type">char</span> *args)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_si</span><span class="params">(<span class="type">char</span> *args)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_info</span><span class="params">(<span class="type">char</span> *args)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_x</span><span class="params">(<span class="type">char</span> *args)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_p</span><span class="params">(<span class="type">char</span> *args)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_w</span><span class="params">(<span class="type">char</span> *args)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_d</span><span class="params">(<span class="type">char</span> *args)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *description;</span><br><span class="line">  <span class="type">int</span> (*handler) (<span class="type">char</span> *);</span><br><span class="line">} cmd_table [] = {</span><br><span class="line">  { <span class="string">"help"</span>, <span class="string">"Display information about all supported commands"</span>, cmd_help },</span><br><span class="line">  { <span class="string">"c"</span>, <span class="string">"Continue the execution of the program"</span>, cmd_c },</span><br><span class="line">  { <span class="string">"q"</span>, <span class="string">"Exit NEMU"</span>, cmd_q },</span><br><span class="line">  { <span class="string">"si"</span>, <span class="string">"Single-step execute the program and pause after N instructions, default is 1."</span>, cmd_si },</span><br><span class="line">  { <span class="string">"info"</span>, <span class="string">"Print information about the SUBCMD"</span>, cmd_info },</span><br><span class="line">  { <span class="string">"x"</span>, <span class="string">"Scan memory starting from the address calculated by EXPR, and output N 4-byte hexadecimal values."</span>, cmd_x },</span><br><span class="line">  { <span class="string">"p"</span>, <span class="string">"Evaluate the expression EXPR and print its value."</span>, cmd_p },</span><br><span class="line">  { <span class="string">"w"</span>, <span class="string">"When the value of the expression EXPR changes, pause the program execution."</span>, cmd_w },</span><br><span class="line">  { <span class="string">"d"</span>, <span class="string">"Delete the watchpoint with ID N."</span>, cmd_d },</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>编译后输入help，和一些测试命令，可以得到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(nemu) <span class="built_in">help</span></span><br><span class="line"><span class="built_in">help</span> - Display information about all supported commands</span><br><span class="line">c - Continue the execution of the program</span><br><span class="line">q - Exit NEMU</span><br><span class="line">si - Single-step execute the program and pause after N instructions, default is 1.</span><br><span class="line">info - Print information about the SUBCMD</span><br><span class="line">x - Scan memory starting from the address calculated by EXPR, and output N 4-byte hexadecimal values.</span><br><span class="line">p - Evaluate the expression EXPR and <span class="built_in">print</span> its value.</span><br><span class="line">w - When the value of the expression EXPR changes, pause the program execution.</span><br><span class="line">d - Delete the watchpoint with ID N.</span><br><span class="line">(nemu) w <span class="built_in">expr</span></span><br><span class="line">cmd_wexpr</span><br><span class="line">(nemu) info w</span><br><span class="line">cmd_infow</span><br><span class="line">(nemu) x n <span class="built_in">expr</span></span><br><span class="line">cmd_xn <span class="built_in">expr</span></span><br><span class="line">(nemu) q</span><br></pre></td></tr></table></figure>
<p>接下来就逐个实现功能就可以了。每个函数里对args再处理，然后执行相应的功能。</p>
<h3 id="单步执行">单步执行</h3>
<p>仿照help的实现解析命令，然后判断是否为合法输入，执行即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">isdigits</span><span class="params">(<span class="type">char</span> *s)</span>{</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;s[i]!=<span class="string">'\0'</span>;i++){</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">isdigit</span>(s[i])){</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_si</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  <span class="type">char</span> *arg = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">  <span class="type">int</span> n= <span class="number">1</span>;<span class="comment">//默认为1</span></span><br><span class="line">  <span class="keyword">if</span>(isdigits(arg)){</span><br><span class="line">    n=atoi(arg);</span><br><span class="line">    cpu_exec(n);</span><br><span class="line">  }<span class="keyword">else</span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"invalid input,set n=1\n"</span>);</span><br><span class="line">    cpu_exec(n);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="打印寄存器">打印寄存器</h3>
<p>解析命令，然后打印寄存器，需要修改isa_reg_display</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">isa_reg_display</span><span class="params">()</span> {<span class="comment">//需要包含#include &lt;ctype.h&gt;</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"pc\t"</span> FMT_WORD <span class="string">"\n"</span>, cpu.pc);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ARRLEN(cpu.gpr); i++) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\t"</span> FMT_WORD <span class="string">"\n"</span>, regs[i], cpu.gpr[i]);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_info</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  <span class="type">char</span> *arg = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">  <span class="keyword">switch</span> (*arg){</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'r'</span>:</span><br><span class="line">      isa_reg_display();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'w'</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"cmd_info w\n"</span>);</span><br><span class="line">      <span class="comment">//wp_display();</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"invalid input\n"</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="扫描内存">扫描内存</h3>
<p>记得要包含memory/vaddr.h，memory/paddr.h，"common.h"，"utils.h"，也是解析一下命令行就可以，expr_val得到的是地址，所以需要设置为vaddr_t模拟一个地址。暂时不需要实现表达式的解析，直接接受数字即可。</p>
<blockquote>
<p>用了两个转换函数atoi和stroll，atoi是将字符串转换为整数，strtol是将字符串转换为long
int，第三个参数是进制，0表示自动识别。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_x</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  <span class="type">char</span> *argN = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);<span class="comment">//第一个参数</span></span><br><span class="line">  <span class="type">char</span> *argExpr = strtok(<span class="literal">NULL</span>, <span class="string">""</span>);<span class="comment">//第二个参数</span></span><br><span class="line">  <span class="type">size_t</span> n = <span class="number">0</span>;</span><br><span class="line">  <span class="type">vaddr_t</span> expr_val;</span><br><span class="line">  <span class="type">uint32_t</span> read;</span><br><span class="line">  <span class="comment">// 命令解析</span></span><br><span class="line">  <span class="keyword">if</span> (!(argN &amp;&amp; argExpr)) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Inputs should not be empty\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span>(isdigits(argN)){</span><br><span class="line">    n = atoi(argN);</span><br><span class="line">  }<span class="keyword">else</span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"N should be integer and greater than 0\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 表达式解析，暂时不解析只是数字</span></span><br><span class="line">  expr_val = strtol(argExpr,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">  <span class="comment">// 检查地址是否在内存范围内</span></span><br><span class="line">  <span class="keyword">if</span> (!in_pmem(expr_val)) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"address = "</span> FMT_WORD <span class="string">" is out of bound of pmem ["</span> FMT_PADDR <span class="string">", "</span> FMT_PADDR <span class="string">"]\n"</span>,</span><br><span class="line">      expr_val, PMEM_LEFT, PMEM_RIGHT);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 输出结果</span></span><br><span class="line">  <span class="built_in">printf</span>(FMT_WORD <span class="string">":"</span>, expr_val);<span class="comment">//格式化输出word</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; n; i++) {</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">4</span> == <span class="number">0</span>) { <span class="built_in">putchar</span>(<span class="string">'\n'</span>); }</span><br><span class="line">    read = (<span class="type">uint32_t</span>)vaddr_read(expr_val, <span class="number">4</span>);<span class="comment">//4个字节</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"0x%08x "</span>, read);</span><br><span class="line">    expr_val += <span class="number">4</span>;<span class="comment">//地址加4</span></span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>尝试运行一下，得到如下结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Welcome to riscv32-NEMU!</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span></span><br><span class="line">(nemu) x 10 0x80000000</span><br><span class="line">0x80000000:</span><br><span class="line">0x00000297 0x00028823 0x0102c503 0x00100073 </span><br><span class="line">0xdeadbeef 0x2c2c2c2c 0x2c2c2c2c 0x2c2c2c2c </span><br><span class="line">0x2c2c2c2c 0x2c2c2c2c </span><br><span class="line">(nemu) </span><br></pre></td></tr></table></figure>
<p>写到这里，第一部分就结束了（不得不说确实有些难度）</p>
<h2 id="表达式求值">表达式求值</h2>
<blockquote>
<p>这一块涉及到一些编译原理也涉及一些数据结构的知识，一个是词法分析，一个是如何计算表达式（STFW）。顺带推荐一下nju的编译原理，甚至还提供校外oj账号，nju课程还是太优质了。</p>
</blockquote>
<p>修改expr.c文件，看一节nju编译原理的antlr就差不多明白了，可以按照那一节的内容指定规则。首先制定规则（为了后面调试方便，指定一张表输出对应字符）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> {</span></span><br><span class="line">  TK_NOTYPE=<span class="number">0</span>, TK_EQ, TK_UEQ,</span><br><span class="line">  TK_NUM, TK_HEX, TK_REG, </span><br><span class="line">  TK_DEREF, TK_MINUS</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *token_str[] = {</span><br><span class="line">  <span class="string">"TK_NOTYPE"</span>, <span class="string">"TK_EQ"</span>, <span class="string">"TK_UEQ"</span>,</span><br><span class="line">  <span class="string">"TK_NUM"</span>, <span class="string">"TK_HEX"</span>, <span class="string">"TK_REG"</span>, </span><br><span class="line">  <span class="string">"TK_DEREF"</span>, <span class="string">"TK_MINUS"</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">rule</span> {</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *regex;</span><br><span class="line">  <span class="type">int</span> token_type;</span><br><span class="line">} rules[] = {</span><br><span class="line">  {<span class="string">"0x[0-9A-Fa-f]+"</span>, TK_HEX},   <span class="comment">//hex(要先于数字匹配)</span></span><br><span class="line">  {<span class="string">"\\$[0-9a-z]+"</span>, TK_REG},     <span class="comment">//register</span></span><br><span class="line">  {<span class="string">"[0-9]+"</span>,TK_NUM},            <span class="comment">// number</span></span><br><span class="line">  {<span class="string">"\\("</span>, <span class="string">'('</span>},         <span class="comment">// left parenthesis</span></span><br><span class="line">  {<span class="string">"\\)"</span>, <span class="string">')'</span>},         <span class="comment">// right parenthesis</span></span><br><span class="line">  {<span class="string">"\\+"</span>, <span class="string">'+'</span>},         <span class="comment">// plus</span></span><br><span class="line">  {<span class="string">"\\-"</span>, <span class="string">'-'</span>},         <span class="comment">// sub</span></span><br><span class="line">  {<span class="string">"\\*"</span>, <span class="string">'*'</span>},         <span class="comment">// mul</span></span><br><span class="line">  {<span class="string">"\\/"</span>, <span class="string">'/'</span>},         <span class="comment">// divide</span></span><br><span class="line">  {<span class="string">" +"</span>, TK_NOTYPE},    <span class="comment">// spaces</span></span><br><span class="line">  {<span class="string">"=="</span>, TK_EQ},        <span class="comment">// equal</span></span><br><span class="line">  {<span class="string">"!="</span>, TK_UEQ},       <span class="comment">// unequal </span></span><br><span class="line">  {<span class="string">"&amp;&amp;"</span>, <span class="string">'&amp;'</span>},          <span class="comment">// and</span></span><br><span class="line">  {<span class="string">"\\|\\|"</span>, <span class="string">'|'</span>}       <span class="comment">// or </span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>后面要处理运算优先级，所以再给个获取运算优先级的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">get_priority</span><span class="params">(<span class="type">char</span> type)</span>{</span><br><span class="line">  <span class="keyword">switch</span> (type) {</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'|'</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'&amp;'</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> TK_EQ:</span><br><span class="line">  <span class="keyword">case</span> TK_UEQ:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="string">'+'</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'-'</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">case</span> <span class="string">'*'</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>首先呢，是分割TOKEN，代码已经给好了框架，遍历规则识别（这里和前面rule的顺序是对应上的，正是因为遍历所以需要hex在最前面识别）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">make_token</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *e)</span> {</span><br><span class="line">  <span class="type">int</span> position = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="type">regmatch_t</span> pmatch;</span><br><span class="line"></span><br><span class="line">  nr_token = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (e[position] != <span class="string">'\0'</span>) {</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NR_REGEX; i ++) {<span class="comment">//遍历规则</span></span><br><span class="line">      <span class="keyword">if</span> (regexec(&amp;re[i], e + position, <span class="number">1</span>, &amp;pmatch, <span class="number">0</span>) == <span class="number">0</span> &amp;&amp; pmatch.rm_so == <span class="number">0</span>) {</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *substr_start = e + position;</span><br><span class="line">        <span class="type">int</span> substr_len = pmatch.rm_eo;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (substr_len &gt; <span class="number">32</span>){</span><br><span class="line">          assert(<span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        Log(<span class="string">"match rules[%d] = \"%s\" at position %d with len %d: %.*s"</span>,</span><br><span class="line">            i, rules[i].regex, position, substr_len, substr_len, substr_start);</span><br><span class="line"></span><br><span class="line">        position += substr_len;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">switch</span> (rules[i].token_type) {</span><br><span class="line">          <span class="keyword">case</span> TK_NOTYPE:<span class="comment">//直接跳过</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">case</span> <span class="string">'*'</span>:<span class="comment">// 解引用和符号判断一样</span></span><br><span class="line">          <span class="keyword">case</span> <span class="string">'-'</span>:</span><br><span class="line">            <span class="keyword">if</span> (nr_token == <span class="number">0</span> || tokens[nr_token - <span class="number">1</span>].type == <span class="string">'('</span> || get_priority(tokens[nr_token - <span class="number">1</span>].type) != <span class="number">-1</span>){</span><br><span class="line">              <span class="keyword">switch</span> (rules[i].token_type)</span><br><span class="line">              {</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'*'</span>:</span><br><span class="line">                  tokens[nr_token].type = TK_DEREF;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'-'</span>:</span><br><span class="line">                  tokens[nr_token].type = TK_MINUS;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              }</span><br><span class="line">            }<span class="keyword">else</span> <span class="keyword">if</span> (tokens[nr_token - <span class="number">1</span>].type == <span class="string">')'</span> </span><br><span class="line">              || tokens[nr_token - <span class="number">1</span>].type == TK_NUM || tokens[nr_token - <span class="number">1</span>].type == TK_HEX</span><br><span class="line">              || tokens[nr_token - <span class="number">1</span>].type == TK_REG){</span><br><span class="line">              tokens[nr_token].type = rules[i].token_type;<span class="comment">//减法或者乘法</span></span><br><span class="line">            }<span class="keyword">else</span> {</span><br><span class="line">              Log(<span class="string">"error: nr_token-1:%s, nr_token:%s "</span>, tokens[nr_token - <span class="number">1</span>].str, token_str[rules[i].token_type]);</span><br><span class="line">              assert(<span class="number">0</span>);</span><br><span class="line">            }</span><br><span class="line">            nr_token++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">case</span> TK_HEX:<span class="comment">//都是一串字符，统一处理</span></span><br><span class="line">          <span class="keyword">case</span> TK_REG:</span><br><span class="line">          <span class="keyword">case</span> TK_NUM:</span><br><span class="line">            <span class="built_in">memcpy</span>(tokens[nr_token].str, e + position - substr_len, (substr_len) * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            tokens[nr_token].str[substr_len] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">case</span> <span class="string">'('</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">')'</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'+'</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'/'</span>: </span><br><span class="line">          <span class="keyword">case</span> <span class="string">'|'</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'&amp;'</span>:</span><br><span class="line">          <span class="keyword">case</span> TK_EQ:</span><br><span class="line">          <span class="keyword">case</span> TK_NEQ:</span><br><span class="line">            tokens[nr_token].type = rules[i].token_type;<span class="comment">//没有特殊处理</span></span><br><span class="line">            nr_token++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            Log(<span class="string">"Lack of rules"</span>);</span><br><span class="line">            assert(<span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i == NR_REGEX) {</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"no match at position %d\n%s\n%*.s^\n"</span>, position, e, position, <span class="string">""</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>然后是eval求值，课程也给了框架，明显需要递归解决，递归的依据是有几个token</p>
<ul>
<li>一个token需要处理hex，num，reg这三种</li>
<li>两个token需要处理负数和解引用</li>
<li>多个token需要判断括号 然后是计算优先级，最后递归得到左右值计算</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> <span class="title function_">eval</span><span class="params">(<span class="type">int</span> p, <span class="type">int</span> q, <span class="type">bool</span> *success, <span class="type">int</span> *position)</span> {</span><br><span class="line">  <span class="keyword">if</span> (p &gt; q) {<span class="comment">//空串错误</span></span><br><span class="line">    *success = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span> (p == q) {<span class="comment">//单token，处理地址</span></span><br><span class="line">    <span class="type">uint32_t</span> buffer = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">switch</span> (tokens[p].type){</span><br><span class="line">      <span class="keyword">case</span> TK_HEX:</span><br><span class="line">        <span class="built_in">sscanf</span>(tokens[p].str, <span class="string">"%x"</span>, &amp;buffer);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">case</span> TK_NUM:</span><br><span class="line">        <span class="built_in">sscanf</span>(tokens[p].str, <span class="string">"%u"</span>, &amp;buffer);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> TK_REG:</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(tokens[p].str, <span class="string">"$pc"</span>) == <span class="number">0</span>){</span><br><span class="line">          buffer = cpu.pc;</span><br><span class="line">          *success = <span class="literal">true</span>;</span><br><span class="line">        }<span class="keyword">else</span> {</span><br><span class="line">          buffer = isa_reg_str2val(tokens[p].str, success);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!*success){</span><br><span class="line">          *position = p;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        Log(<span class="string">"error for a singal token: %s"</span>, tokens[p].str);</span><br><span class="line">        assert(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line">  }<span class="keyword">else</span> <span class="keyword">if</span> (q - p == <span class="number">1</span> || check_parentheses(p + <span class="number">1</span>, q, position) == <span class="literal">true</span>){<span class="comment">//两toke为负数和解引用</span></span><br><span class="line">    <span class="keyword">switch</span> (tokens[p].type) {</span><br><span class="line">    <span class="keyword">case</span> TK_DEREF:</span><br><span class="line">      <span class="keyword">return</span> *((<span class="type">uint32_t</span> *)guest_to_host(eval(p + <span class="number">1</span>, q, success, position)));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">case</span> TK_MINUS:</span><br><span class="line">      <span class="keyword">return</span> -eval(p + <span class="number">1</span>, q, success, position);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      assert(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span> (check_parentheses(p, q, position) == <span class="literal">true</span>) {<span class="comment">//是否是括号</span></span><br><span class="line">    <span class="keyword">return</span> eval(p + <span class="number">1</span>, q - <span class="number">1</span>, success, position);</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="keyword">if</span> (*position != <span class="number">-1</span>){</span><br><span class="line">      *success = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> op = <span class="number">-1</span>, level = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = p; i &lt;= q; ++i){<span class="comment">//优先级处理</span></span><br><span class="line">      <span class="keyword">if</span> (tokens[i].type == <span class="string">'('</span>){<span class="comment">//(越多说明越里层</span></span><br><span class="line">        level++;</span><br><span class="line">      } <span class="keyword">else</span> <span class="keyword">if</span> (tokens[i].type == <span class="string">')'</span>){</span><br><span class="line">        level--;</span><br><span class="line">      } <span class="keyword">else</span> <span class="keyword">if</span> (level == <span class="number">-1</span> &amp;&amp; get_priority(tokens[i].type) &gt;= <span class="number">0</span>){</span><br><span class="line">        <span class="keyword">if</span> (op == <span class="number">-1</span> || get_priority(tokens[i].type) &lt;= get_priority(tokens[op].type)){<span class="comment">// 求最高级</span></span><br><span class="line">          op = i;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (op == <span class="number">-1</span>){<span class="comment">//没有运算符</span></span><br><span class="line">      *success = <span class="literal">false</span>;</span><br><span class="line">      *position = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> val1 = eval(p, op - <span class="number">1</span>, success, position);</span><br><span class="line">    <span class="type">uint32_t</span> val2 = eval(op + <span class="number">1</span>, q, success, position);</span><br><span class="line">    <span class="keyword">switch</span> (tokens[op].type) {</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'+'</span>: <span class="keyword">return</span> val1 + val2;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'-'</span>: <span class="keyword">return</span> val1 - val2;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'*'</span>: <span class="keyword">return</span> val1 * val2;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'/'</span>: <span class="keyword">return</span> val1 / val2;</span><br><span class="line">      <span class="keyword">case</span> TK_EQ: <span class="keyword">return</span> val1 == val2;</span><br><span class="line">      <span class="keyword">case</span> TK_NEQ: <span class="keyword">return</span> val1 != val2;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'|'</span>: <span class="keyword">return</span> val1 || val2;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'&amp;'</span>: <span class="keyword">return</span> val1 &amp;&amp; val2;</span><br><span class="line">      <span class="keyword">default</span>: </span><br><span class="line">      Log(<span class="string">"error for a operator: %s"</span>, tokens[op].str);</span><br><span class="line">      assert(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>然后，然后就终于结束了😢。调试了很久，而且许多函数也不会用，编译原理也不太会，还是太困难了。
展示一下结果吧</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">(nemu) x 10 0x80000000+(0x00001000+0x00001000*12-256*16*1*12)</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[0] = <span class="string">"0x[0-9A-Fa-f]+"</span> at position 0 with len 10: 0x80000000</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[5] = <span class="string">"\+"</span> at position 10 with len 1: +</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[3] = <span class="string">"\("</span> at position 11 with len 1: (</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[0] = <span class="string">"0x[0-9A-Fa-f]+"</span> at position 12 with len 10: 0x00001000</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[5] = <span class="string">"\+"</span> at position 22 with len 1: +</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[0] = <span class="string">"0x[0-9A-Fa-f]+"</span> at position 23 with len 10: 0x00001000</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[7] = <span class="string">"\*"</span> at position 33 with len 1: *</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[2] = <span class="string">"[0-9]+"</span> at position 34 with len 2: 12</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[6] = <span class="string">"\-"</span> at position 36 with len 1: -</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[2] = <span class="string">"[0-9]+"</span> at position 37 with len 3: 256</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[7] = <span class="string">"\*"</span> at position 40 with len 1: *</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[2] = <span class="string">"[0-9]+"</span> at position 41 with len 2: 16</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[7] = <span class="string">"\*"</span> at position 43 with len 1: *</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[2] = <span class="string">"[0-9]+"</span> at position 44 with len 1: 1</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[7] = <span class="string">"\*"</span> at position 45 with len 1: *</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[2] = <span class="string">"[0-9]+"</span> at position 46 with len 2: 12</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[4] = <span class="string">"\)"</span> at position 48 with len 1: )</span><br><span class="line">0x80001000:</span><br><span class="line">0x49494949 0x49494949 0x49494949 0x49494949 </span><br><span class="line">0x49494949 0x49494949 0x49494949 0x49494949 </span><br><span class="line">0x49494949 0x49494949 </span><br><span class="line">(nemu) x 10 0x80000000+0x00001000</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[0] = <span class="string">"0x[0-9A-Fa-f]+"</span> at position 0 with len 10: 0x80000000</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[5] = <span class="string">"\+"</span> at position 10 with len 1: +</span><br><span class="line">[src/monitor/sdb/expr.c:126 make_token] match rules[0] = <span class="string">"0x[0-9A-Fa-f]+"</span> at position 11 with len 10: 0x00001000</span><br><span class="line">0x80001000:</span><br><span class="line">0x49494949 0x49494949 0x49494949 0x49494949 </span><br><span class="line">0x49494949 0x49494949 0x49494949 0x49494949 </span><br><span class="line">0x49494949 0x49494949 </span><br><span class="line">(nemu) </span><br></pre></td></tr></table></figure>
<blockquote>
<p>休息、休息一下P1.2</p>
</blockquote>
<h2 id="监视点">监视点</h2>
<h3 id="添加监视点信息">添加监视点信息</h3>
<p>首先呢，我们需要试试gdb的watch功能，看看监视点都有什么功能，并且在watchpoint结构体里添加合适的成员。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_WATCHPOINT_LEN 32</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span>{</span></span><br><span class="line">  hw,</span><br><span class="line">  sw,</span><br><span class="line">}wp_type;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *wp_type_str[] = {</span><br><span class="line">  <span class="string">"hw"</span>, </span><br><span class="line">  <span class="string">"sw"</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">watchpoint</span> {</span><span class="comment">//监视点链表</span></span><br><span class="line"><span class="comment">// 监视点信息</span></span><br><span class="line">  <span class="type">int</span> NO;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">watchpoint</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="type">bool</span> enabled;</span><br><span class="line">  wp_type type;</span><br><span class="line">  <span class="comment">// 目标信息</span></span><br><span class="line">  <span class="type">char</span> what[MAX_WATCHPOINT_LEN];</span><br><span class="line">  <span class="type">uint32_t</span> expr_addr; <span class="comment">// 存放表达式结果 , 即内存地址</span></span><br><span class="line">  <span class="type">uint32_t</span> val;       <span class="comment">// 执行指令之前的值</span></span><br><span class="line">} WP;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="监视点的分配和释放">监视点的分配和释放</h3>
<p>首先不考虑如何输入监视的内容，只考虑监视池的分配（这里修改了free的返回类型为bool）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新建节点</span></span><br><span class="line">WP* <span class="title function_">new_wp</span><span class="params">()</span> {</span><br><span class="line">  <span class="keyword">if</span> (free_ == <span class="literal">NULL</span>) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"No available watchpoint.\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  WP *cur = free_;</span><br><span class="line">  free_ = free_-&gt;next;</span><br><span class="line"></span><br><span class="line">  cur-&gt;next = head;<span class="comment">//插入链表的前端</span></span><br><span class="line">  head = cur;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化监视点</span></span><br><span class="line">  cur-&gt;enabled = <span class="literal">true</span>;  <span class="comment">// 默认启用监视点</span></span><br><span class="line">  cur-&gt;NO = cur-wp_pool; <span class="comment">// 编号</span></span><br><span class="line">  <span class="keyword">return</span> cur;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放节点</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">free_wp</span><span class="params">(WP *wp)</span> {</span><br><span class="line">  <span class="keyword">if</span> (wp == <span class="literal">NULL</span>) {<span class="comment">// 判断当前节点</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"No such watchpoint.\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  WP *cur = head;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//从占用链表删除</span></span><br><span class="line">  <span class="keyword">if</span>(wp ==head){<span class="comment">//如果是头节点</span></span><br><span class="line">    head = head-&gt;next;<span class="comment">//从占有链表删除</span></span><br><span class="line">  }<span class="keyword">else</span>{</span><br><span class="line">    <span class="keyword">while</span>(cur-&gt;next!=wp&amp;&amp;cur-&gt;next!=<span class="literal">NULL</span>){<span class="comment">//查找节点</span></span><br><span class="line">      cur = cur-&gt;next;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(cur-&gt;next==wp){</span><br><span class="line">      cur-&gt;next = wp-&gt;next;<span class="comment">//从占有链表删除</span></span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"No such watchpoint be used.\n"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">//加入空闲链表</span></span><br><span class="line">  <span class="keyword">if</span>(free_ != <span class="literal">NULL</span>){<span class="comment">//空闲链表非空</span></span><br><span class="line">    wp-&gt;next=free_-&gt;next;<span class="comment">//加入空闲</span></span><br><span class="line">    free_-&gt;next = wp;</span><br><span class="line">  }<span class="keyword">else</span>{</span><br><span class="line">    wp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    free_ = wp;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>然后给出打印监视点和监视池的信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">print_watchpoint</span><span class="params">(WP* wp, <span class="type">bool</span> all)</span>{<span class="comment">//打印某个监视点</span></span><br><span class="line">  WP *cur = wp;</span><br><span class="line">  <span class="keyword">if</span>(all)<span class="built_in">printf</span>(<span class="string">"No\t\t  addr  \t\t  value   \t\t  what   \t\ttype\t\tstatus\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%2d\t\t0x%08x\t\t%10d\t\t%s\t\t%4s\t\t%s\n"</span>, </span><br><span class="line">    cur-&gt;NO, cur-&gt;expr_addr, cur-&gt;val, cur-&gt;what, wp_type_str[cur-&gt;type], cur-&gt;enabled ? <span class="string">"enabled"</span> : <span class="string">"disabled"</span>);</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_watchpoints</span><span class="params">()</span><span class="comment">//打印所有监视点</span></span><br><span class="line">{</span><br><span class="line">  WP *cur = head;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"No\t\t  addr  \t\t  value   \t\t  what   \t\ttype\t\tstatus\n"</span>);</span><br><span class="line">  <span class="keyword">while</span> (cur != <span class="literal">NULL</span>)</span><br><span class="line">  {</span><br><span class="line">    print_watchpoint(cur,<span class="literal">true</span>);</span><br><span class="line">    cur = cur-&gt;next;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> ;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_head_free</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  WP *cur_h = head;</span><br><span class="line">  WP *cur_f = free_;</span><br><span class="line">  Log(<span class="string">"used monitors=\t"</span>);</span><br><span class="line">  <span class="keyword">while</span> (cur_h != <span class="literal">NULL</span>)</span><br><span class="line">  {</span><br><span class="line">    Log(<span class="string">"%d\t"</span>, cur_h-&gt;NO);</span><br><span class="line">    cur_h = cur_h-&gt;next;</span><br><span class="line">  }</span><br><span class="line">  Log(<span class="string">"unused monitors=\t"</span>);</span><br><span class="line">  <span class="keyword">while</span> (cur_f != <span class="literal">NULL</span>)</span><br><span class="line">  {</span><br><span class="line">    Log(<span class="string">"%d\t"</span>, cur_f-&gt;NO);</span><br><span class="line">    cur_f = cur_f-&gt;next;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="完善命令">完善命令</h3>
<p>然后去完善命令, 一共有三个命令，分别是
<code>d N</code>,<code>info w</code>, <code>w EXPR</code>
d比较简单，再写一个del函数调用free即可，我们的NO是按照地址分配的，所以不需要遍历查找，因为名称我们用了malloc，所以一定要记得free
其他命令在对应的cmd中完善</p>
<p>w Expr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 命令w</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_w</span><span class="params">(<span class="type">char</span>* args)</span> {</span><br><span class="line">  <span class="type">char</span> *argExpr = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);<span class="comment">//第一个参数</span></span><br><span class="line">  WP* wp = new_wp();</span><br><span class="line">  <span class="type">int</span> expr_val;</span><br><span class="line">  <span class="type">bool</span> success = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 命令解析</span></span><br><span class="line">  <span class="keyword">if</span> (!(argExpr)) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Inputs should not be empty\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  expr_val = expr(argExpr, &amp;success);</span><br><span class="line">  <span class="keyword">if</span> (!success) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Invalid expression\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 检查地址是否在内存范围内</span></span><br><span class="line">  <span class="keyword">if</span> (!in_pmem(expr_val)) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"address = "</span> FMT_WORD <span class="string">" is out of bound of pmem ["</span> FMT_PADDR <span class="string">", "</span> FMT_PADDR <span class="string">"]\n"</span>,</span><br><span class="line">      expr_val, PMEM_LEFT, PMEM_RIGHT);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">//监控点信息</span></span><br><span class="line">  wp-&gt;what = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(argExpr) + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(wp-&gt;what, argExpr);</span><br><span class="line">  wp-&gt;expr_addr = expr_val;</span><br><span class="line">  wp-&gt;val = (<span class="type">uint32_t</span>)vaddr_read(expr_val, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>info w</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//命令info w</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'w'</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"cmd_info w\n"</span>);</span><br><span class="line">      print_watchpoints();</span><br><span class="line">      <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>d N</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_d</span><span class="params">(<span class="type">char</span> *args)</span> {</span><br><span class="line">  <span class="type">int</span> n=<span class="number">-1</span>;</span><br><span class="line">  <span class="type">char</span> *argN = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);<span class="comment">//第一个参数</span></span><br><span class="line">  <span class="keyword">if</span> (!(argN)) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Inputs should not be empty\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span>(isdigits(argN)){</span><br><span class="line">    n = atoi(argN);</span><br><span class="line">  }<span class="keyword">else</span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"N should be integer and greater than 0\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  delete_wp(n);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除监视点</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete_wp</span><span class="params">(<span class="type">int</span> NO)</span> {</span><br><span class="line">  WP *cur = &amp;wp_pool[NO];</span><br><span class="line">  <span class="built_in">free</span>(cur-&gt;what);</span><br><span class="line">  <span class="keyword">if</span>(free_wp(cur)){</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Delete watchpoint %d.\n"</span>, NO);</span><br><span class="line">  }<span class="keyword">else</span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Delete watchpoint %d failed.\n"</span>, NO);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="结果展示">结果展示</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(nemu) w 0x80000000</span><br><span class="line">[src/monitor/sdb/expr.c:109 make_token] match rules[0] = <span class="string">"0x[0-9A-Fa-f]+"</span> at position 0 with len 10: 0x80000000</span><br><span class="line">(nemu) w 0x80001000</span><br><span class="line">[src/monitor/sdb/expr.c:109 make_token] match rules[0] = <span class="string">"0x[0-9A-Fa-f]+"</span> at position 0 with len 10: 0x80001000</span><br><span class="line">(nemu) w 0x80001001</span><br><span class="line">[src/monitor/sdb/expr.c:109 make_token] match rules[0] = <span class="string">"0x[0-9A-Fa-f]+"</span> at position 0 with len 10: 0x80001001</span><br><span class="line">(nemu) w 0x80001002</span><br><span class="line">[src/monitor/sdb/expr.c:109 make_token] match rules[0] = <span class="string">"0x[0-9A-Fa-f]+"</span> at position 0 with len 10: 0x80001002</span><br><span class="line">(nemu) info w</span><br><span class="line">cmd_info w</span><br><span class="line">No                addr                    value                   what                  <span class="built_in">type</span>            status</span><br><span class="line"> 3              0x80001002               437918234              0x80001002                hw            enabled</span><br><span class="line"> 2              0x80001001               437918234              0x80001001                hw            enabled</span><br><span class="line"> 1              0x80001000               437918234              0x80001000                hw            enabled</span><br><span class="line"> 0              0x80000000                     663              0x80000000                hw            enabled</span><br><span class="line">(nemu) d 0</span><br><span class="line">Delete watchpoint 0.</span><br><span class="line">(nemu) d 1</span><br><span class="line">Delete watchpoint 1.</span><br><span class="line">(nemu) info w</span><br><span class="line">cmd_info w</span><br><span class="line">No                addr                    value                   what                  <span class="built_in">type</span>            status</span><br><span class="line"> 3              0x80001002               437918234              0x80001002                hw            enabled</span><br><span class="line"> 2              0x80001001               437918234              0x80001001                hw            enabled</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PA1至此打工告成，代码中许多功能其实并不是很完善，不过已经花了很多时间有空再修正吧
后面的章节随缘更新吧，没想的pa的代码量这么大😢</p>
</blockquote>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/mysitesource/yaanblog.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/mysitesource/yaanblog.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">Yaan</div><div class="post-copyright__author_desc">欢迎光临（￣︶￣）</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://yaanlaan.github.io/2024/08/27/njuicspa1/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://yaanlaan.github.io/2024/08/27/njuicspa1/')">njuicspa1</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://yaanlaan.github.io/2024/08/27/njuicspa1/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yaanlaan.github.io" target="_blank">Yaan</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/nju-ics-2023/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>nju-ics-2023<span class="categoryesPageCount">1</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>计算机系统基础<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/ics/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>ics<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/pa/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>pa<span class="tagsPageCount">1</span></a></div></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/16/games101lab8/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/postimage/%E7%94%B5%E6%AC%A1%E4%B8%89%E9%B9%B0.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">games101lab8</div></div></a></div><div class="next-post pull-right"><a href="/2024/09/12/cs144lab0/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/postimage/lego.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">cs144lab0</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/mysitesource/yaanblog.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2021/01/15/591aaf707ee3c.png" alt="status"/></div></div><div class="author-info__description">草木山石，日月星辰</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Yaan</h1><div class="author-info__desc">欢迎光临（￣︶￣）</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/yaanlaan" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://www.zhihu.com/people/4-56-20-42" target="_blank" title="Zhihu"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhihu-circle-fill"></use></svg></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">小破站今天也在苟活QAQ</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nju-ics-pa1"><span class="toc-text">NJU ICS PA1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%84%89%E5%BF%AB%E7%9A%84pa%E4%B9%8B%E5%89%8D"><span class="toc-text">愉快的PA之前</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A4%A9%E8%BE%9F%E5%9C%B0%E7%9A%84%E7%AF%87%E7%AB%A0"><span class="toc-text">开天辟地的篇章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rtfsc"><span class="toc-text">RTFSC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%B0%8F%E5%AE%9E%E9%AA%8C"><span class="toc-text">第一个小实验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E5%90%8E%E5%B0%8F%E7%BB%83%E4%B9%A0%E4%BC%98%E9%9B%85%E7%9A%84%E9%80%80%E5%87%BA"><span class="toc-text">课后小练习：优雅的退出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD"><span class="toc-text">基础设施</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%91%BD%E4%BB%A4"><span class="toc-text">解析命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E6%AD%A5%E6%89%A7%E8%A1%8C"><span class="toc-text">单步执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-text">打印寄存器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E5%86%85%E5%AD%98"><span class="toc-text">扫描内存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B1%82%E5%80%BC"><span class="toc-text">表达式求值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E8%A7%86%E7%82%B9"><span class="toc-text">监视点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%9B%91%E8%A7%86%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="toc-text">添加监视点信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E8%A7%86%E7%82%B9%E7%9A%84%E5%88%86%E9%85%8D%E5%92%8C%E9%87%8A%E6%94%BE"><span class="toc-text">监视点的分配和释放</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E5%96%84%E5%91%BD%E4%BB%A4"><span class="toc-text">完善命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-text">结果展示</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/09/18/cs144lab1/" title="cs144lab1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/postimage/yyy/24.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="cs144lab1"/></a><div class="content"><a class="title" href="/2024/09/18/cs144lab1/" title="cs144lab1">cs144lab1</a><time datetime="2024-09-18T11:48:49.000Z" title="发表于 2024-09-18 19:48:49">2024-09-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/12/cs144lab0/" title="cs144lab0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/postimage/lego.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="cs144lab0"/></a><div class="content"><a class="title" href="/2024/09/12/cs144lab0/" title="cs144lab0">cs144lab0</a><time datetime="2024-09-12T07:05:51.000Z" title="发表于 2024-09-12 15:05:51">2024-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/27/njuicspa1/" title="njuicspa1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/postimage/%E8%80%81%E5%85%AB2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="njuicspa1"/></a><div class="content"><a class="title" href="/2024/08/27/njuicspa1/" title="njuicspa1">njuicspa1</a><time datetime="2024-08-27T11:24:09.000Z" title="发表于 2024-08-27 19:24:09">2024-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/16/games101lab8/" title="games101lab8"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/postimage/%E7%94%B5%E6%AC%A1%E4%B8%89%E9%B9%B0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="games101lab8"/></a><div class="content"><a class="title" href="/2024/08/16/games101lab8/" title="games101lab8">games101lab8</a><time datetime="2024-08-16T00:46:20.000Z" title="发表于 2024-08-16 08:46:20">2024-08-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/14/games101lab7/" title="games101lab7"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/postimage/%E5%A4%A9%E5%8F%B0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="games101lab7"/></a><div class="content"><a class="title" href="/2024/08/14/games101lab7/" title="games101lab7">games101lab7</a><time datetime="2024-08-14T14:17:58.000Z" title="发表于 2024-08-14 22:17:58">2024-08-14</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><div id="runtimeTextTip"></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2024 By <a class="footer-bar-link" href="/" title="Yaan" target="_blank">Yaan</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = []
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">12</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><span> 文章</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><span> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:toRandomPost()"><span> 随便逛逛</span></a></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 0.88rem;">C++<sup>9</sup></a><a href="/tags/LINGO/" style="font-size: 0.88rem;">LINGO<sup>2</sup></a><a href="/tags/MATLAB/" style="font-size: 0.88rem;">MATLAB<sup>11</sup></a><a href="/tags/Mind-Walk/" style="font-size: 0.88rem;">Mind Walk<sup>1</sup></a><a href="/tags/c/" style="font-size: 0.88rem;">c++<sup>2</sup></a><a href="/tags/cmake/" style="font-size: 0.88rem;">cmake<sup>2</sup></a><a href="/tags/cs144/" style="font-size: 0.88rem;">cs144<sup>2</sup></a><a href="/tags/ics/" style="font-size: 0.88rem;">ics<sup>1</sup></a><a href="/tags/opencv/" style="font-size: 0.88rem;">opencv<sup>1</sup></a><a href="/tags/pa/" style="font-size: 0.88rem;">pa<sup>1</sup></a><a href="/tags/stl/" style="font-size: 0.88rem;">stl<sup>1</sup></a><a href="/tags/tools/" style="font-size: 0.88rem;">tools<sup>2</sup></a><a href="/tags/%E4%BF%A1%E6%81%AF%E8%AE%BA/" style="font-size: 0.88rem;">信息论<sup>1</sup></a><a href="/tags/%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B/" style="font-size: 0.88rem;">微分方程<sup>2</sup></a><a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 0.88rem;">排序<sup>1</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 0.88rem;">数字图像处理<sup>1</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6%E5%BB%BA%E6%A8%A1/" style="font-size: 0.88rem;">数学建模<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 0.88rem;">数据结构<sup>1</sup></a><a href="/tags/%E6%95%B0%E8%AE%BA/" style="font-size: 0.88rem;">数论<sup>1</sup></a><a href="/tags/%E6%9C%AC%E7%A7%91%E7%AC%94%E8%AE%B0/" style="font-size: 0.88rem;">本科笔记<sup>13</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 0.88rem;">模板<sup>1</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 0.88rem;">测试<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95%E6%9D%82%E8%B0%88/" style="font-size: 0.88rem;">算法杂谈<sup>2</sup></a><a href="/tags/%E7%BA%BF%E6%80%A7%E8%A7%84%E5%88%92/" style="font-size: 0.88rem;">线性规划<sup>2</sup></a><a href="/tags/%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98/" style="font-size: 0.88rem;">背包问题<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/" style="font-size: 0.88rem;">计算机图形学<sup>9</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">计算机系统基础<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">计算机网络<sup>2</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("03/14/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2024 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Yaan 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("03/14/2024 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "";
        img.title = "";
        img.alt = "";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js').then(runMermaid)
  }

  anzhiyu.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script async src="https://at.alicdn.com/t/c/font_4614032_rt5w4p7bq3i.js?spm=a313x.manage_type_myprojects.i1.10.372c3a817mQWHJ&amp;file=font_4614032_rt5w4p7bq3i.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/haru01.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>